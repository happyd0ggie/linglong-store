name: Release
run-name: Release ${{ inputs.tag }}
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. 2.0.1) Please follow Semantic Versioning specifications.'
        required: true
        type: string

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - arch: amd64
            docker-platform: linux/amd64
          - arch: arm64
            docker-platform: linux/arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU (for ARM64 cross-compilation)
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Rust, pnpm, and target
        uses: actions/cache@v4
        with:
          path: |
            .cargo
            .rustup
            .pnpm-store
            src-tauri/target
          key: ${{ runner.os }}-${{ matrix.arch }}-build-${{ hashFiles('src-tauri/Cargo.lock', 'src-tauri/Cargo.toml', 'Cargo.lock', 'Cargo.toml', 'pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-build-

      - name: Build for ${{ matrix.arch }}
        run: |
          mkdir -p .cargo .rustup .pnpm-store
          docker run --rm \
            --platform ${{ matrix.docker-platform }} \
            -v $(pwd):/workspace \
            -w /workspace \
            -e NODE_ENV=pro \
            -e DEBIAN_FRONTEND=noninteractive \
            -e CARGO_HOME=/workspace/.cargo \
            -e RUSTUP_HOME=/workspace/.rustup \
            node:20-bookworm \
            bash -c "
              export PATH=\"\$CARGO_HOME/bin:\$PATH\" && \
              # å®‰è£…ç³»ç»Ÿä¾èµ–
              apt-get update && \
              apt-get install -y \
                curl \
                wget \
                file \
                libgtk-3-dev \
                libwebkit2gtk-4.1-dev \
                libjavascriptcoregtk-4.1-dev \
                libsoup-3.0-dev \
                librsvg2-dev \
                patchelf \
                pkg-config \
                build-essential \
                xdg-utils && \
              \
              # å®‰è£… Rust
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && \
              . \"\$CARGO_HOME/env\" && \
              \
              # å®‰è£… pnpm
              corepack enable && \
              corepack prepare pnpm@9 --activate && \
              \
              # å®‰è£…å‰ç«¯ä¾èµ–
              pnpm config set store-dir /workspace/.pnpm-store && \
              pnpm install --frozen-lockfile && \
              pnpm build:pro
            "

      - name: Collect artifacts for ${{ matrix.arch }}
        run: |
          set -euo pipefail
          mkdir -p release-bin release-appimage release-deb release-rpm
          BIN_TARGET="release-bin/linglong-store-${{ matrix.arch }}"
          if [ -f src-tauri/target/release/linglong-store ]; then
            cp src-tauri/target/release/linglong-store "$BIN_TARGET"
            chmod +x "$BIN_TARGET"
          fi
          find src-tauri/target/release/bundle -maxdepth 2 -type f -name "*.AppImage" -exec cp {} release-appimage/ \; 2>/dev/null || true
          find src-tauri/target/release/bundle -maxdepth 2 -type f -name "*.deb" -exec cp {} release-deb/ \; 2>/dev/null || true
          find src-tauri/target/release/bundle -maxdepth 2 -type f -name "*.rpm" -exec cp {} release-rpm/ \; 2>/dev/null || true
          ls -la release-bin || true

      - name: Upload artifacts (${matrix.arch})
        uses: actions/upload-artifact@v4
        with:
          name: linglong-store-${{ matrix.arch }}
          path: |
            release-bin/linglong-store-${{ matrix.arch }}
            release-appimage/*.AppImage
            release-deb/*.deb
            release-rpm/*.rpm
          if-no-files-found: warn

  create-release:
    needs: release
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.tag }}
          target_commitish: ${{ github.sha }}
          name: 'ç²ç‘åº”ç”¨å•†åº—ç¤¾åŒºç‰ˆ v${{ inputs.tag }}'
          body: |
            ## ç²ç‘åº”ç”¨å•†åº—ç¤¾åŒºç‰ˆ ${{ inputs.tag }}
            
            ### ä¸‹è½½å®‰è£…
            è¯·æ ¹æ®æ‚¨çš„ Linux å‘è¡Œç‰ˆå’Œ CPU æ¶æ„é€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
            
            #### x86_64 (AMD64)
             ğŸ”¹ `*-amd64.AppImage` / `*-x86_64.AppImage` - é€šç”¨æ ¼å¼ï¼Œä¸‹è½½åæ·»åŠ å¯æ‰§è¡Œæƒé™å³å¯è¿è¡Œ
             ğŸ”¹ `*_amd64.deb` - é€‚ç”¨äº Debian/Ubuntu/Deepin ç­‰å‘è¡Œç‰ˆ
             ğŸ”¹ `*-amd64.rpm` - é€‚ç”¨äº Fedora/openSUSE ç­‰å‘è¡Œç‰ˆ
             ğŸ”¹ `linglong-store-amd64` - åŸå§‹å¯æ‰§è¡Œæ–‡ä»¶
            
            #### ARM64 (aarch64)
             ğŸ”¹ `*-arm64.AppImage` / `*-aarch64.AppImage` - é€šç”¨æ ¼å¼ï¼Œä¸‹è½½åæ·»åŠ å¯æ‰§è¡Œæƒé™å³å¯è¿è¡Œ
             ğŸ”¹ `*_arm64.deb` / `*_aarch64.deb` - é€‚ç”¨äº Debian/Ubuntu/Deepin ç­‰å‘è¡Œç‰ˆ
             ğŸ”¹ `*-arm64.rpm` / `*-aarch64.rpm` - é€‚ç”¨äº Fedora/openSUSE ç­‰å‘è¡Œç‰ˆ
             ğŸ”¹ `linglong-store-arm64` - åŸå§‹å¯æ‰§è¡Œæ–‡ä»¶
            
            ### ç³»ç»Ÿè¦æ±‚
            - Linux æ“ä½œç³»ç»Ÿï¼ˆæ”¯æŒ x86_64 å’Œ ARM64ï¼‰
            - å·²å®‰è£…ç²ç‘åŒ…ç®¡ç†å™¨ (ll-cli)
            - GTK 3.0+
            - WebKit2GTK 4.1+
            
          draft: true
          prerelease: ${{ contains(inputs.tag, 'alpha') || contains(inputs.tag, 'beta') || contains(inputs.tag, 'rc') }}
          files: |
            artifacts/**/release-bin/*
            artifacts/**/release-appimage/*
            artifacts/**/release-deb/*
            artifacts/**/release-rpm/*
